<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Services</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
       integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
       crossorigin=""/>
      <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
       integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
       crossorigin=""></script>
<!--    <link rel="stylesheet" href="style.css">-->
    <style>
        table {width:100%;}
        table, th, td {border: 1px solid black; border-collapse: collapse;}
        th, td {padding: 15px; text-align: left;}
        table td input {width: 100%; box-sizing: border-box;}
        .withInput {padding: 10px; font-size: 18px;}
        select {font-size: 16px}
        .redRow {background-color: rgba(202, 7, 30, 0.8)}
        .blueRow {background-color: rgba(0, 127, 255, 0.8)}
        .greenRow {background-color: rgba(66, 200, 66, 0.8)}
        .yellowRow {background-color: rgba(255, 211, 37, 0.8)}
    </style>
    <link rel="stylesheet" href="style.css" type="text/css">

</head>
<header>
    <h1 id="main-label" style="text-align: center; color: maroon;">Korshi Komekshi</h1>
</header>
<body>
    <form id="first-block" style="text-align: center;">
        <section class="request">
          <label for='category'>Выберите Категорию:</label>
          <select id='category' name='category' value='category'>
              <option value='Выпечка'>Выпечка</option>
              <option value='Горячая Еда'>Горячая Еда</option>
          </select>
          <br>
          <br>
          <section class="price">
          <label for="price">Выберите Цену До:</label>
    			<input type="text" name="price" id="price">
          </section>
        </section>
        <br>
        <input value="ПОИСК" type="button" onclick="getBuildings()">
    </form>
    <hr>

    <section id="more-info">
        <div id="map" style="left: 50%; transform: translate(-50%, 0%); height: 750px; width: 900px">
        </div>
    </section>
    <br>

    <script type="text/javascript">
        const api_url = 'http://0.0.0.0:8001/b';
        const redIcon = new L.Icon({
              iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
        const greenIcon = new L.Icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
        const goldIcon = new L.Icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });

        var map = L.map('map').setView([51.1605, 71.4704], 10);

        const attribution =
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        L.tileLayer(tileUrl, { attribution }).addTo(map);
        let circlesGroup = L.featureGroup();

        function drawData(circles, input_value, is_from_yard) {
            let count = 0;
            let res = circles['res'];
            map.removeLayer(circlesGroup);
            circlesGroup = L.featureGroup();

            // clear old rable data
            let table = document.getElementById("buildings");
            if (table.rows.length > 1) {
                console.log('clearing old rows');
                for (let i = table.rows.length; i > 1; i--) {
                    table.deleteRow(1)
                }
            }

            // get yard_num for selected building (first building with distance 0)
            let my_yard_num = res[0]['yard_num'];
            // draw center of yard as red dot
            if(is_from_yard) {
                let cntr = circles['center'].slice(6,-1).split(" ");
                L.marker([cntr[1], cntr[0]], {icon: redIcon}).addTo(circlesGroup)
                    .bindPopup('dvor center').openPopup();
                my_yard_num = input_value;
            }

            res.forEach(
                function drawCicle(c, _) {
                    let loc = c['location'].slice(6,-1).split(" ");
                    let rowColor = 'redRow';
                    if (c['postcode'] === input_value) {
                        L.marker([loc[1], loc[0]], {icon: redIcon}).addTo(circlesGroup)
                          .bindPopup(`${c['postcode']}`).openPopup();
                        count++;
                    } else {
                        count++;
                        if (c['yard_num'] != null) {
                            console.log(my_yard_num, c['yard_num']);
                            if ((c['yard_num']) === my_yard_num) {
                                L.marker([loc[1], loc[0]], {icon: greenIcon}).addTo(circlesGroup)
                                    .bindPopup(`${c['postcode']}<br>${c['yard_num']}`).openPopup();
                                rowColor = 'greenRow';

                            } else {
                                L.marker([loc[1], loc[0]], {icon: goldIcon}).addTo(circlesGroup)
                                    .bindPopup(`${c['postcode']}<br>${c['yard_num']}`).openPopup();
                                rowColor = 'yellowRow';
                            }
                        } else {
                            L.marker([loc[1], loc[0]]).addTo(circlesGroup)
                                .bindPopup(`${c['postcode']}`).openPopup();
                            rowColor = 'blueRow';
                        }

                    }
                    insertToTable(c, count, rowColor)
                });
            map.addLayer(circlesGroup);
            console.log('number of points on map', count)
        }

        function getBuildings() {
            let search_choice = document.getElementById('search_choice').value;
            let z = document.getElementById('input_zipcode').value;
            let r = document.getElementById('input_dist').value;
            let search_url = `${api_url}/close_buildings?postcode=${z}&dist=${r}`;
            if (search_choice === 'dvor') {
                search_url = `${api_url}/close_buildings?yard=${z}&dist=${r}`;
            }
            fetch(search_url, {
                method: "GET",
            }).then(
                function(data) {
                    data.json().then(
                        function(c) {
                            console.log(c);
                            if (search_choice === 'dvor') {
                                drawData(c, z, true)
                            } else {
                                drawData(c, z, false)
                            }
                        }
                    )
                }
            ).catch(
                function(error){
                    if (error != null) {
                        console.log('could not get buildings; something went wrong...');
                        console.log(error);
                    } else {
                        console.log('everything is fine')
                    }
                }
            );
        }

        function insertToTable(data, row_num, rowColor) {
            let table = document.getElementById("buildings");
            let row = table.insertRow(row_num);
            let p = row.insertCell(0);
            let s = row.insertCell(1);
            let b = row.insertCell(2);
            let d = row.insertCell(3);
            let yard = row.insertCell(4);
            row.className = rowColor;
            p.innerHTML = `${data['postcode']}`;
            s.innerHTML = `${data['street']}`;
            b.innerHTML = `${data['building']}`;
            d.innerHTML = `${data['distance']}`;
            if (data['yard_num'] == null) {
                yard.innerHTML = `<input type="text" class= "withInput" "value="">`;
            } else {
                yard.innerHTML = `<input type="text" class= "withInput" value="${data['yard_num']}">`;
            }
        }

        function sendYards() {
            let table = document.getElementById("buildings");
            yards_map = {};
            for (let i = 1; i < table.rows.length; i++) {
                let building = table.rows[i].cells[0].innerHTML;
                yards_map[building] = table.rows[i].cells[4].firstElementChild.value;
            }
            console.log('sending yards');
            fetch(`${api_url}/yards`, {
                method: "PUT",
                body: JSON.stringify(yards_map)
            }).then(
                function(data) {
                    data.json().then(
                        function(res) {
                            console.log(res);
                            alert(res['msg'])
                        }
                    )
                }
            ).catch(
                function(error){
                    if (error != null) {
                        console.log('could not get buildings; something went wrong...');
                        console.log(error);
                    } else {
                        console.log('everything is fine')
                    }
                }
            );
        }
    </script>
</body>
</html>
